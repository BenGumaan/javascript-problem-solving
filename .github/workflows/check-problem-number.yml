name: 🔎 Check for Duplicate Problem Numbers and Save Detailed Log

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-duplicates:
    runs-on: ubuntu-latest
    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v3

      - name: 🔍 Scan files and check duplicates
        run: |
          set +e  # Disable exit on error to handle errors manually
          echo "📂 Scanning for problem files in all directories..."

          # Find all .js files matching pattern, allow empty results without failing
          files=$(find . -type f -name '*.js' | grep -Eo './.*[0-9]+\. [^/]*\.js' 2>/dev/null || true)
          files=$(echo "$files" | sort)

          echo "Found files:"
          echo "$files"

          if [ -z "$files" ]; then
            echo "⚠️ No problem files found matching the pattern. Exiting gracefully."
            exit 0
          fi

          echo "[" > problems-log.json

          first=true
          while IFS= read -r file; do
            clean_file="${file#./}"
            number=$(echo "$clean_file" | grep -Eo '^[0-9]+')

            if $first; then
              first=false
            else
              echo "," >> problems-log.json
            fi

            echo "  { \"id\": $number, \"file\": \"$clean_file\" }" >> problems-log.json
          done <<< "$files"

          echo "" >> problems-log.json
          echo "]" >> problems-log.json

          echo "📝 Detailed problem log created in problems-log.json:"
          cat problems-log.json

          numbers=$(echo "$files" | grep -Eo '^[0-9]+' | sort)
          echo "Extracted numbers:"
          echo "$numbers"

          duplicates=$(echo "$numbers" | uniq -d)

          if [ ! -z "$duplicates" ]; then
            echo "🚫 Duplicate problem numbers detected:"
            echo "$duplicates"
            echo "::error ::Duplicate problem number(s) detected: $duplicates"
            exit 1
          fi

          echo "✅ No duplicate problem numbers found. All good!"